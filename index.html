<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Flashcards</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- JS libraries for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVBL5gI9kLmbGkknNRZn1emmkSUpA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .flashcard-container {
            perspective: 1000px;
            -webkit-perspective: 1000px;
        }
        .flashcard {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            -webkit-transform-style: preserve-3d;
            transition: transform 0.7s cubic-bezier(0.4, 0.2, 0.2, 1);
        }
        .is-flipped {
            transform: rotateY(180deg);
        }
        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .flashcard-back {
            transform: rotateY(180deg) translateZ(1px); /* Safari rendering fix */
            -webkit-transform: rotateY(180deg) translateZ(1px); /* Safari rendering fix */
            justify-content: flex-start;
            align-items: flex-start;
            overflow-y: auto;
        }
        .flashcard-back h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #4f46e5;
        }
        .flashcard-back p {
            font-size: 0.90rem;
            line-height: 1.6;
            margin-bottom: 0.75rem;
        }
        /* Tab Styles */
        .tab-btn {
            padding: 0.5rem 1rem;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        .active-tab {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
        }
        /* Modal Styles */
        #addCardModal {
            transition: opacity 0.3s ease;
        }
        /* Market Chart Styles */
        .market-chart {
            width: 100%;
            height: 120px;
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            border-left: 2px solid #e5e7eb;
            border-bottom: 2px solid #e5e7eb;
            padding-top: 10px;
            margin-top: 1rem;
        }
        .chart-bar-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            justify-content: flex-end;
        }
        .chart-bar {
            width: 25px;
            background-color: #6366f1;
            border-radius: 4px 4px 0 0;
            position: relative;
            transition: height 0.5s ease-out;
        }
        .bar-value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            font-weight: 600;
            color: #4f46e5;
        }
        .bar-year {
            font-size: 0.7rem;
            color: #6b7280;
            margin-top: 4px;
        }
        /* Drag and Drop style */
        .drag-over {
             border-color: #4f46e5;
             background-color: #eef2ff;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-100 via-purple-100 to-pink-100 text-slate-800 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-2xl mx-auto p-4 sm:p-6 text-center">
        <!-- Header -->
        <header class="mb-6">
            <h1 class="text-4xl font-bold text-slate-900">AI-Powered Flashcards</h1>
            <p class="text-slate-600 mt-2">Create, Study, and Export with AI Assistance</p>
        </header>

        <!-- Flashcard Component -->
        <div class="flashcard-container w-full h-[30rem] sm:h-[28rem]">
            <div class="flashcard">
                <div id="flashcard-front" class="flashcard-face">
                    <div class="absolute top-4 right-4 hidden" id="selection-checkbox-container">
                        <input type="checkbox" id="selection-checkbox" class="h-6 w-6 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    </div>
                    <h2 class="text-2xl sm:text-3xl font-semibold text-center"></h2>
                </div>
                <div class="flashcard-face flashcard-back">
                     <div class="w-full flex flex-col h-full">
                        <div class="flex-shrink-0 w-full flex border-b border-slate-200 mb-2">
                            <button class="tab-btn active-tab" data-content="summary">Summary</button>
                            <button class="tab-btn" data-content="market">Market Snapshot</button>
                        </div>
                        <div class="flex-grow overflow-y-auto">
                            <div id="summary-content" class="tab-content text-left"></div>
                            <div id="market-content" class="tab-content hidden text-left"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Controls -->
        <div id="action-controls" class="flex items-center justify-center space-x-2 sm:space-x-4 mt-6">
            <button id="shuffleBtn" class="p-3 bg-white/80 border border-slate-200 rounded-full shadow-sm text-slate-700 font-semibold hover:bg-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200" title="Shuffle Cards">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></svg>
            </button>
            <button id="flipBtn" class="px-6 py-3 bg-indigo-600 text-white rounded-full shadow-lg font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200 flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 17l5-5-5-5M19.8 12H2M8 7l-5 5 5 5"/></svg>
                <span>Flip Card</span>
            </button>
            <!-- Export Buttons -->
            <button id="exportPdfBtn" class="p-3 bg-white/80 border border-slate-200 rounded-full shadow-sm text-slate-700 font-semibold hover:bg-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200" title="Export as PDF">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><polyline points="9 15 12 12 15 15"></polyline></svg>
            </button>
             <button id="exportTxtBtn" class="p-3 bg-white/80 border border-slate-200 rounded-full shadow-sm text-slate-700 font-semibold hover:bg-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200" title="Export as Text">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="9" y1="13" x2="15" y2="13"></line><line x1="9" y1="17" x2="15" y2="17"></line><line x1="9" y1="9" x2="9" y2="9"></line></svg>
            </button>
        </div>

        <!-- Selection Action Controls -->
        <div id="selection-controls" class="hidden items-center justify-center space-x-2 sm:space-x-4 mt-6">
            <button id="selectAllBtn" class="px-4 py-2 bg-white/80 border border-slate-300 rounded-full text-sm font-semibold text-slate-700 hover:bg-slate-50 transition">Select All</button>
            <button id="editCardBtn" class="px-4 py-2 bg-blue-500 text-white rounded-full text-sm font-semibold hover:bg-blue-600 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/></svg>
                Edit
            </button>
            <button id="deleteCardsBtn" class="px-4 py-2 bg-red-500 text-white rounded-full text-sm font-semibold hover:bg-red-600 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2" disabled>
                 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg>
                Delete
            </button>
        </div>


        <!-- Navigation Controls -->
        <div class="flex items-center justify-center space-x-4 mt-4">
            <button id="prevBtn" class="p-4 bg-white/80 border border-slate-200 rounded-full shadow-sm text-slate-700 font-semibold hover:bg-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed" title="Previous">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <span id="cardCounter" class="text-lg font-medium text-slate-700 w-24"></span>
            <button id="nextBtn" class="p-4 bg-white/80 border border-slate-200 rounded-full shadow-sm text-slate-700 font-semibold hover:bg-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed" title="Next">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
            </button>
        </div>
    </div>
    
    <!-- Footer and Action Buttons -->
    <footer class="fixed bottom-4 left-4 right-4 z-10 flex justify-between">
        <div class="flex items-center gap-2">
             <button id="addCardBtn" class="px-4 py-2 bg-white/80 backdrop-blur-sm rounded-full text-sm text-slate-600 hover:text-slate-900 transition shadow-md flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                 Add Card
             </button>
             <button id="manageDeckBtn" class="px-4 py-2 bg-white/80 backdrop-blur-sm rounded-full text-sm text-slate-600 hover:text-slate-900 transition shadow-md flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-collection" viewBox="0 0 16 16"><path d="M2.5 3.5a.5.5 0 0 1 0-1h11a.5.5 0 0 1 0 1zM2.5 7.5a.5.5 0 0 1 0-1h11a.5.5 0 0 1 0 1zM2.5 11.5a.5.5 0 0 1 0-1h11a.5.5 0 0 1 0 1z"/></svg>
                 <span id="manageDeckBtnText">Manage Deck</span>
             </button>
        </div>
         <button id="feedbackBtn" class="px-4 py-2 bg-white/80 backdrop-blur-sm rounded-full text-sm text-slate-600 hover:text-slate-900 transition shadow-md">Give Feedback</button>
    </footer>
    
    <!-- Add/Edit Card Modal -->
    <div id="addCardModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-6 relative">
            <button id="closeModalBtn" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800">&times;</button>
            <h3 id="modalTitle" class="text-xl font-semibold mb-4">Add a New Flashcard</h3>
            <form id="addCardForm">
                <!-- Screenshot Upload -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-700 text-left mb-2">Upload a screenshot</label>
                    <div id="dropZone" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-slate-300 border-dashed rounded-md transition-colors duration-200">
                        <div class="space-y-1 text-center">
                            <svg class="mx-auto h-12 w-12 text-slate-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <div class="flex text-sm text-slate-600 justify-center">
                                <label for="screenshotUpload" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500">
                                    <span>Upload a file</span>
                                    <input id="screenshotUpload" name="screenshotUpload" type="file" class="sr-only" accept="image/*">
                                </label>
                                <p class="pl-1">or drag and drop</p>
                            </div>
                            <p class="text-xs text-slate-500">PNG, JPG, GIF</p>
                            <p id="fileName" class="text-xs text-slate-700 font-medium pt-1"></p>
                        </div>
                    </div>
                </div>
                <div class="text-center my-4 text-sm font-semibold text-slate-500">--- OR ---</div>
                
                <!-- Manual Entry -->
                <div class="mb-4">
                    <label for="cardTitle" class="block text-sm font-medium text-slate-700 text-left mb-1">Title</label>
                    <input type="text" id="cardTitle" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., The Future of Quantum Computing" required>
                </div>
                <div class="mb-4">
                    <label for="cardSummary" class="block text-sm font-medium text-slate-700 text-left mb-1">Summary</label>
                    <textarea id="cardSummary" rows="4" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" placeholder="Provide a brief summary of the topic." required></textarea>
                </div>
                 <div class="flex justify-end items-center gap-4">
                    <button id="generateAIBtn" type="button" class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-md font-semibold hover:bg-indigo-200 transition flex items-center gap-2">
                         <svg id="ai-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.5 13.5c.34.34.66.7.97 1.09.28.36.55.73.81 1.12.26.39.52.78.77 1.18.25.4.5.8.74 1.21.24.41.48.82.72 1.24.23.4.47.8.7 1.19.23.39.46.78.68 1.17.22.39.44.78.65 1.17s.42.78.62 1.17c.2.39.4.78.59 1.17.19.39.38.78.56 1.17.18.39.36.78.54 1.17.18.39.35.78.52 1.17.17.39.34.78.51 1.17.17.39.33.78.49 1.17.16.39.32.78.48 1.17.16.39.31.78.46 1.17.15.39.3.78.45 1.17.15.39.29.78.43 1.17.14.39.28.78.42 1.17.14.39.27.78.41 1.17.14.39.27.78.4 1.17.13.39.26.78.39 1.17.13.39.25.78.38 1.17.13.39.25.78.37 1.17.12.39.24.78.36 1.17.12.39.23.78.35 1.17.12.39.23.78.34 1.17.11.39.22.78.33 1.17.11.39.22.78.32 1.17.1.39.21.78.31 1.17.1.39.2.78.3 1.17.1.39.19.78.29 1.17.1.39.19.78.28 1.17.09.39.18.78.27 1.17.09.39.18.78.27 1.17.09.39.17.78.26 1.17.09.39.17.78.25 1.17.08.39.16.78.24 1.17.08.39.16.78.24 1.17.08.39.15.78.23 1.17.08.39.15.78.22 1.17.07.39.14.78.21 1.17.07.39.14.78.21 1.17.07.39.13.78.2 1.17.07.39.13.78.2 1.17.06.39.12.78.19 1.17.06.39.12.78.18 1.17.06.39.12.78.18 1.17.06.39.11.78.17 1.17.05.39.11.78.16 1.17.05.39.1.78.15 1.17.05.39.1.78.15 1.17.05.39.09.78.14 1.17.04.39.09.78.13 1.17.04.39.08.78.12 1.17.04.39.08.78.12 1.17.04.39.07.78.11 1.17.03.39.07.78.1 1.17.03.39.06.78.09 1.17.03.39.06.78.09 1.17.03.39.05.78.08 1.17.02.39.05.78.07 1.17.02.39.04.78.06 1.17.02.39.04.78.06 1.17.02.39.03.78.05 1.17.01.39.03.78.04 1.17.01.39.02.78.03 1.17.01.39.02.78.03 1.17.01.39.01.78.02 1.17.01.39.01.78.01 1.17z"/><path d="m14.5 9.5-.97-1.09c-.28-.36-.55-.73-.81-1.12c-.26-.39-.52-.78-.77-1.18c-.25-.4-.5-.8-.74-1.21c-.24-.41-.48-.82-.72-1.24c-.23-.4-.47-.8-.7-1.19c-.23-.39-.46-.78-.68-1.17c-.22-.39-.44-.78-.65-1.17s-.42-.78-.62-1.17c-.2-.39-.4-.78-.59-1.17c-.19-.39-.38-.78-.56-1.17c-.18-.39-.36-.78-.54-1.17c-.18-.39-.35-.78-.52-1.17c-.17-.39-.34-.78-.51-1.17c-.17-.39-.33-.78-.49-1.17c-.16-.39-.32-.78-.48-1.17c-.16-.39-.31-.78-.46-1.17c-.15-.39-.3-.78-.45-1.17c-.15-.39-.29-.78-.43-1.17c-.14-.39-.28-.78-.42-1.17c-.14-.39-.27-.78-.41-1.17c-.14-.39-.27-.78-.4-1.17c-.13-.39-.26-.78-.39-1.17c-.13-.39-.25-.78-.38-1.17c-.13-.39-.25-.78-.37-1.17c-.12-.39-.24-.78-.36-1.17c-.12-.39-.23-.78-.35-1.17c-.12-.39-.23-.78-.34-1.17c-.11-.39-.22-.78-.33-1.17c-.11-.39-.22-.78-.32-1.17c-.1-.39-.21-.78-.31-1.17c-.1-.39-.2-.78-.3-1.17c-.1-.39-.19-.78-.29-1.17c-.1-.39-.19-.78-.28-1.17c-.09-.39-.18-.78-.27-1.17c-.09-.39-.18-.78-.27-1.17c-.09-.39-.17-.78-.26-1.17c-.09-.39-.17-.78-.25-1.17c-.08-.39-.16-.78-.24-1.17c-.08-.39-.16-.78-.24-1.17c-.08-.39-.15-.78-.23-1.17c-.08-.39-.15-.78-.22-1.17c-.07-.39-.14-.78-.21-1.17c-.07-.39-.14-.78-.21-1.17c-.07-.39-.13-.78-.2-1.17c-.07-.39-.13-.78-.2-1.17c-.06-.39-.12-.78-.19-1.17c-.06-.39-.12-.78-.18-1.17c-.06-.39-.12-.78-.18-1.17c-.06-.39-.11-.78-.17-1.17c-.05-.39-.11-.78-.16-1.17c-.05-.39-.1-.78-.15-1.17c-.05-.39-.1-.78-.15-1.17c-.05-.39-.09-.78-.14-1.17c-.04-.39-.09-.78-.13-1.17c-.04-.39-.08-.78-.12-1.17c-.04-.39-.08-.78-.12-1.17c-.04-.39-.07-.78-.11-1.17c-.03-.39-.07-.78-.1-1.17c-.03-.39-.06-.78-.09-1.17c-.03-.39-.06-.78-.09-1.17c-.03-.39-.05-.78-.08-1.17c-.02-.39-.05-.78-.07-1.17c-.02-.39-.04-.78-.06-1.17c-.02-.39-.04-.78-.06-1.17c-.02-.39-.03-.78-.05-1.17c-.01-.39-.03-.78-.04-1.17c-.01-.39-.02-.78-.03-1.17c-.01-.39-.02-.78-.03-1.17c-.01-.39-.01-.78-.02-1.17c-.01-.39-.01-.78-.01-1.17z"/></svg>
                         <svg id="ai-loader" class="animate-spin h-5 w-5 text-indigo-700 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                         </svg>
                         <span id="ai-btn-text">Generate Market Data</span>
                    </button>
                    <button id="formSubmitBtn" type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md font-semibold hover:bg-indigo-700 transition">Add Card to Deck</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 text-center">
            <h3 class="text-lg font-semibold mb-2">Confirm Deletion</h3>
            <p id="deleteConfirmText" class="text-slate-600 mb-6">Are you sure you want to delete the selected card(s)? This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="cancelDeleteBtn" class="px-6 py-2 bg-slate-200 text-slate-800 rounded-md font-semibold hover:bg-slate-300 transition">Cancel</button>
                <button id="confirmDeleteBtn" class="px-6 py-2 bg-red-600 text-white rounded-md font-semibold hover:bg-red-700 transition">Delete</button>
            </div>
        </div>
    </div>


        <script>
        const { jsPDF } = window.jspdf;
        const apiKey = "AIzaSyDnEXbl4H664dLyY6SXlRH4IFwHX0EdVew";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const LOCAL_STORAGE_KEY = 'aiFlashcardsData';

        // --- Helper function to create chart HTML ---
        function createBarChart(data, unit) {
            if (!data || data.length === 0) return '<p>No chart data available.</p>';
            const maxValue = Math.max(...data.map(d => d.value));
            const bars = data.map(d => `
                <div class="chart-bar-group">
                    <div class="chart-bar" style="height: ${(d.value / maxValue) * 100}%;">
                        <span class="bar-value">${unit}${d.value}</span>
                    </div>
                    <span class="bar-year">${d.year}</span>
                </div>
            `).join('');
            return `<div class="market-chart">${bars}</div>`;
        }
        
        // --- Data Persistence Functions ---
        function loadData() {
            const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    return Array.isArray(parsedData) && parsedData.length > 0 ? parsedData : getDefaultData();
                } catch (e) {
                    console.error("Error parsing saved data:", e);
                    return getDefaultData(); // Return default if parsing fails
                }
            }
            return getDefaultData(); // Return default if no data saved
        }

        function saveData() {
             try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(flashcardsData));
            } catch (e) {
                console.error("Error saving data:", e);
                alert("Could not save flashcards. Your browser's storage might be full or private mode is enabled.");
            }
        }

        function getDefaultData() {
             return [
                {
                    front: "FDA Approves Zoryve Cream",
                    summary: "The FDA has approved roflumilast 0.05% cream for pediatric atopic dermatitis, a non-contagious chronic skin condition. This steroid-free, once-daily treatment targets the underlying inflammatory causes of eczema.",
                    marketInfo: `
                        <h3>Market Snapshot: Atopic Dermatitis</h3>
                        <p>The global atopic dermatitis market is projected to grow from ~$14B in 2024 to over $22B by 2029, with a CAGR of <strong>9.8%</strong>. This growth is driven by rising prevalence and the launch of novel biologic and non-steroidal therapies.</p>
                        ${createBarChart([
                            { year: 2021, value: 11.2 }, { year: 2022, value: 12.1 }, { year: 2023, value: 13.0 }, { year: 2024, value: 14.1 }, { year: 2025, value: 15.5 }
                        ], '$')}
                    `,
                    chartData: [ { year: 2021, value: 11.2 }, { year: 2022, value: 12.1 }, { year: 2023, value: 13.0 }, { year: 2024, value: 14.1 }, { year: 2025, value: 15.5 } ]
                },
                {
                    front: "Roche's $2.7B Carmot Deal",
                    summary: "Roche announced a definitive merger agreement to acquire Carmot Therapeutics for $2.7 billion upfront, gaining access to its R&D portfolio of clinical-stage incretins, including a promising Phase-2 ready dual GLP-1/GIP agonist, CT-388.",
                    marketInfo: `
                        <h3>Market Snapshot: Obesity Drugs</h3>
                        <p>The global obesity drug market is experiencing explosive growth, projected to soar from ~$35B in 2024 to over $100B by 2030, with a CAGR of over <strong>25%</strong>. This is fueled by highly effective GLP-1 agonists.</p>
                        ${createBarChart([
                            { year: 2021, value: 2.5 }, { year: 2022, value: 6 }, { year: 2023, value: 20 }, { year: 2024, value: 35 }, { year: 2025, value: 55 }
                        ], '$')}
                    `,
                    chartData: [ { year: 2021, value: 2.5 }, { year: 2022, value: 6 }, { year: 2023, value: 20 }, { year: 2024, value: 35 }, { year: 2025, value: 55 } ]
                },
            ];
        }
        
        // --- Initial Flashcard Data ---
        let flashcardsData = loadData();

        // --- DOM Elements ---
        const frontEl = document.getElementById('flashcard-front').querySelector('h2');
        const summaryContentEl = document.getElementById('summary-content');
        const marketContentEl = document.getElementById('market-content');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const cardCounterEl = document.getElementById('cardCounter');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const flipBtn = document.getElementById('flipBtn');
        const shuffleBtn = document.getElementById('shuffleBtn');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const exportTxtBtn = document.getElementById('exportTxtBtn');
        const flashcardEl = document.querySelector('.flashcard');
        const feedbackBtn = document.getElementById('feedbackBtn');
        const actionControls = document.getElementById('action-controls');
        
        // Modal Elements
        const addCardBtn = document.getElementById('addCardBtn');
        const addCardModal = document.getElementById('addCardModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const addCardForm = document.getElementById('addCardForm');
        const generateAIBtn = document.getElementById('generateAIBtn');
        const aiLoader = document.getElementById('ai-loader');
        const aiIcon = document.getElementById('ai-icon');
        const aiBtnText = document.getElementById('ai-btn-text');
        const screenshotUpload = document.getElementById('screenshotUpload');
        const fileNameEl = document.getElementById('fileName');
        const dropZone = document.getElementById('dropZone');
        const modalTitle = document.getElementById('modalTitle');
        const formSubmitBtn = document.getElementById('formSubmitBtn');

        // Selection Elements
        const manageDeckBtn = document.getElementById('manageDeckBtn');
        const manageDeckBtnText = document.getElementById('manageDeckBtnText');
        const selectionControls = document.getElementById('selection-controls');
        const editCardBtn = document.getElementById('editCardBtn');
        const deleteCardsBtn = document.getElementById('deleteCardsBtn');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const selectionCheckboxContainer = document.getElementById('selection-checkbox-container');
        const selectionCheckbox = document.getElementById('selection-checkbox');

        // Delete Confirmation Modal Elements
        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const deleteConfirmText = document.getElementById('deleteConfirmText');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');


        // --- State Variables ---
        let currentCardIndex = 0;
        let marketDataCache = null;
        let isSelectMode = false;
        let selectedIndices = [];
        let editingCardIndex = null;

        // --- Core Functions ---
        function updateCardContent() {
            if (flashcardsData.length === 0) {
                frontEl.textContent = "No cards in deck. Add one!";
                summaryContentEl.innerHTML = "";
                marketContentEl.innerHTML = "";
                cardCounterEl.textContent = `0 / 0`;
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                if(isSelectMode) toggleSelectMode(); // Exit select mode if no cards left
                return;
            }

            // Ensure currentCardIndex is valid
            if (currentCardIndex >= flashcardsData.length) {
                currentCardIndex = flashcardsData.length - 1;
            }
            if (currentCardIndex < 0) {
                currentCardIndex = 0;
            }

            const card = flashcardsData[currentCardIndex];
            frontEl.textContent = card.front;
            summaryContentEl.innerHTML = `<p>${card.summary}</p>`;
            marketContentEl.innerHTML = card.marketInfo;
            
            cardCounterEl.textContent = `${currentCardIndex + 1} / ${flashcardsData.length}`;
            
            if (flashcardEl.classList.contains('is-flipped')) {
                flashcardEl.classList.remove('is-flipped');
            }

            prevBtn.disabled = currentCardIndex === 0;
            nextBtn.disabled = currentCardIndex === flashcardsData.length - 1;

            renderSelectionState(); // Update checkbox visibility and state

            // Reset tabs to default view
            document.querySelector('[data-content="summary"]').classList.add('active-tab');
            document.querySelector('[data-content="market"]').classList.remove('active-tab');
            summaryContentEl.classList.remove('hidden');
            marketContentEl.classList.add('hidden');
        }

        function shuffleCards() {
            for (let i = flashcardsData.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [flashcardsData[i], flashcardsData[j]] = [flashcardsData[j], flashcardsData[i]];
            }
            currentCardIndex = 0;
            if (isSelectMode) {
                selectedIndices = [];
                updateSelectionControls();
            }
            updateCardContent();
            saveData(); // Save the shuffled order
        }
        
        // --- Selection & Management Functions ---
        function toggleSelectMode() {
            isSelectMode = !isSelectMode;
            actionControls.classList.toggle('hidden');
            actionControls.classList.toggle('flex');
            selectionControls.classList.toggle('hidden');
            selectionControls.classList.toggle('flex');
            
            if (isSelectMode) {
                manageDeckBtnText.textContent = "Cancel";
            } else {
                manageDeckBtnText.textContent = "Manage Deck";
                selectedIndices = [];
            }
            updateSelectionControls();
            renderSelectionState();
        }

        function renderSelectionState() {
             if (isSelectMode && flashcardsData.length > 0) {
                selectionCheckboxContainer.classList.remove('hidden');
                selectionCheckbox.checked = selectedIndices.includes(currentCardIndex);
            } else {
                selectionCheckboxContainer.classList.add('hidden');
            }
        }
        
        function updateSelectionControls() {
            const numSelected = selectedIndices.length;
            editCardBtn.disabled = numSelected !== 1;
            deleteCardsBtn.disabled = numSelected === 0;

            if (numSelected > 0 && numSelected === flashcardsData.length) {
                selectAllBtn.textContent = 'Deselect All';
            } else {
                selectAllBtn.textContent = 'Select All';
            }
        }

        function handleCardSelection() {
            const index = currentCardIndex;
            const isSelected = selectedIndices.includes(index);
            if (isSelected) {
                selectedIndices = selectedIndices.filter(i => i !== index);
            } else {
                selectedIndices.push(index);
            }
            renderSelectionState();
            updateSelectionControls();
        }

        function handleSelectAll() {
            if (selectedIndices.length === flashcardsData.length) {
                selectedIndices = []; // Deselect all
            } else {
                selectedIndices = Array.from({length: flashcardsData.length}, (_, i) => i); // Select all
            }
            renderSelectionState();
            updateSelectionControls();
        }

        function editSelectedCard() {
            if (selectedIndices.length !== 1) return;
            
            editingCardIndex = selectedIndices[0];
            const cardToEdit = flashcardsData[editingCardIndex];
            
            // Pre-fill modal
            document.getElementById('cardTitle').value = cardToEdit.front;
            document.getElementById('cardSummary').value = cardToEdit.summary;
            // Note: We don't re-fill the market data as that's generated. User can re-generate if needed.
            marketDataCache = {
                marketName: 'Existing Data',
                analysis: 'To change market data, please generate it again.',
                cagr: 'N/A',
                chartData: cardToEdit.chartData
            };


            modalTitle.textContent = "Edit Flashcard";
            formSubmitBtn.textContent = "Save Changes";
            
            addCardModal.classList.remove('hidden');
        }

        function deleteSelectedCards() {
            const numSelected = selectedIndices.length;
            if(numSelected === 0) return;

            deleteConfirmText.textContent = `Are you sure you want to delete ${numSelected} card(s)? This action cannot be undone.`;
            deleteConfirmModal.classList.remove('hidden');
        }

        function confirmDeletion() {
            flashcardsData = flashcardsData.filter((_, index) => !selectedIndices.includes(index));
            selectedIndices = [];

            saveData();
            updateSelectionControls();
            updateCardContent();
            deleteConfirmModal.classList.add('hidden');
        }


        // --- AI & Form Functions ---
        async function fetchMarketData(topic) {
            aiLoader.classList.remove('hidden');
            aiIcon.classList.add('hidden');
            aiBtnText.textContent = "Generating...";
            generateAIBtn.disabled = true;

            const prompt = `
                For the topic "${topic}", find the relevant industry market size, its projected Compound Annual Growth Rate (CAGR), and a brief, one-sentence analysis of the key driver.
                Also, provide the market size data for the last 5 years, including the current year.
                
                Return the data ONLY in the following JSON format:
                {
                  "marketName": "Name of the Market",
                  "analysis": "A single sentence analyzing the market growth driver.",
                  "cagr": 9.8,
                  "chartData": [
                    { "year": 2021, "value": 11.2 },
                    { "year": 2022, "value": 12.1 },
                    { "year": 2023, "value": 13.0 },
                    { "year": 2024, "value": 14.1 },
                    { "year": 2025, "value": 15.5 }
                  ]
                }
            `;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) {
                    const errorBody = await response.json().catch(() => ({ error: { message: 'Could not parse error response.' } }));
                    const errorMessage = errorBody.error?.message || response.statusText;
                    throw new Error(`API error (${response.status}): ${errorMessage}`);
                }

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                const cleanedText = text.replace(/```json/g, '').replace(/```/g, '');
                const jsonData = JSON.parse(cleanedText);
                marketDataCache = jsonData; // Cache the data
                alert('Market data generated successfully! You can now add the card.');

            } catch (error) {
                console.error("AI Generation Error:", error);
                alert(`Failed to generate market data. Please check the console for details.\n${error.message}`);
                marketDataCache = null;
            } finally {
                aiLoader.classList.add('hidden');
                aiIcon.classList.remove('hidden');
                aiBtnText.textContent = "Generate Market Data";
                generateAIBtn.disabled = false;
            }
        }
        
        function saveCard(event) {
            event.preventDefault();
            const title = document.getElementById('cardTitle').value;
            const summary = document.getElementById('cardSummary').value;

            if (!marketDataCache) {
                alert('Please generate the AI market data first before saving.');
                return;
            }

            const cardData = {
                front: title,
                summary: summary,
                marketInfo: `
                    <h3>Market Snapshot: ${marketDataCache.marketName}</h3>
                    <p>${marketDataCache.analysis} The market has a projected CAGR of <strong>${marketDataCache.cagr}%</strong>.</p>
                    ${createBarChart(marketDataCache.chartData, '$')}
                `,
                chartData: marketDataCache.chartData
            };
            
            if (editingCardIndex !== null) {
                // Editing existing card
                flashcardsData[editingCardIndex] = cardData;
            } else {
                // Adding new card
                flashcardsData.push(cardData);
                currentCardIndex = flashcardsData.length - 1;
            }

            saveData(); 
            updateCardContent();
            
            closeAndResetModal();
        }

        function closeAndResetModal() {
            addCardModal.classList.add('hidden');
            addCardForm.reset();
            fileNameEl.textContent = '';
            marketDataCache = null;
            editingCardIndex = null;
            // Reset modal to "Add" state
            modalTitle.textContent = "Add a New Flashcard";
            formSubmitBtn.textContent = "Add Card to Deck";
            if (isSelectMode) {
                toggleSelectMode(); // Exit select mode after editing
            }
        }

        // --- Screenshot AI Functions ---
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        async function analyzeScreenshot(file) {
            const statusEl = fileNameEl;
            statusEl.textContent = 'Analyzing image...';
            try {
                const base64Data = await fileToBase64(file);
                const prompt = `Analyze the attached screenshot. Extract a concise title and a brief summary of the content. Return the result ONLY in the following JSON format: {"title": "Extracted Title", "summary": "Extracted Summary"}`;
                
                const payload = {
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inlineData: { mimeType: file.type, data: base64Data } }
                        ]
                    }]
                };

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorBody = await response.json().catch(() => ({ error: { message: 'Could not parse error response.' } }));
                    const errorMessage = errorBody.error?.message || response.statusText;
                    throw new Error(`API error (${response.status}): ${errorMessage}`);
                }

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                const cleanedText = text.replace(/```json/g, '').replace(/```/g, '');
                const jsonData = JSON.parse(cleanedText);

                document.getElementById('cardTitle').value = jsonData.title || '';
                document.getElementById('cardSummary').value = jsonData.summary || '';
                statusEl.textContent = `Analyzed: ${file.name}`;
                alert('Screenshot analyzed and fields populated!');

            } catch(error) {
                console.error("Screenshot Analysis Error:", error);
                alert(`Failed to analyze screenshot. Please check the console for details.\n${error.message}`);
                statusEl.textContent = `Error analyzing ${file.name}`;
            }
        }

        // --- Export Functions ---
        function exportCardAsPDF() {
            if (flashcardsData.length === 0) return;

            const card = flashcardsData[currentCardIndex];
            const { jsPDF } = window.jspdf;

            // Create a temporary container for rendering the PDF content
            const pdfContainer = document.createElement('div');
            // Style for off-screen rendering
            pdfContainer.style.position = 'absolute';
            pdfContainer.style.left = '-9999px';
            pdfContainer.style.width = '650px'; // Fixed width for consistent output
            pdfContainer.style.padding = '20px';
            pdfContainer.style.fontFamily = 'Inter, sans-serif';
            pdfContainer.style.backgroundColor = '#ffffff';
            pdfContainer.style.color = '#1e293b'; // slate-800

            // --- Front Side Content ---
            const frontPage = document.createElement('div');
            frontPage.style.marginBottom = '30px';
            frontPage.style.borderBottom = '1px solid #e2e8f0'; // slate-200
            frontPage.style.paddingBottom = '20px';
            
            const frontHeader = document.createElement('h1');
            frontHeader.textContent = 'Flashcard: Front';
            frontHeader.style.fontSize = '20px';
            frontHeader.style.fontWeight = 'bold';
            frontHeader.style.marginBottom = '15px';
            
            const frontContent = document.createElement('p');
            frontContent.textContent = card.front;
            frontContent.style.fontSize = '24px';
            frontContent.style.textAlign = 'center';
            frontContent.style.padding = '40px 0';

            frontPage.appendChild(frontHeader);
            frontPage.appendChild(frontContent);

            // --- Back Side Content ---
            const backPage = document.createElement('div');

            const backHeader = document.createElement('h1');
            backHeader.textContent = 'Flashcard: Back';
            backHeader.style.fontSize = '20px';
            backHeader.style.fontWeight = 'bold';
            backHeader.style.marginBottom = '15px';

            const summaryHeader = document.createElement('h2');
            summaryHeader.textContent = 'Summary';
            summaryHeader.style.fontSize = '18px';
            summaryHeader.style.fontWeight = '600';
            summaryHeader.style.color = '#4f46e5';
            summaryHeader.style.marginBottom = '8px';

            const summaryContent = document.createElement('p');
            summaryContent.textContent = card.summary;
            summaryContent.style.fontSize = '14px';
            summaryContent.style.lineHeight = '1.6';
            summaryContent.style.marginBottom = '20px';

            // Create market content from innerHTML to preserve chart
            const marketContentWrapper = document.createElement('div');
            marketContentWrapper.innerHTML = card.marketInfo;
            // Ensure chart renders correctly by re-applying essential styles
            const chartEl = marketContentWrapper.querySelector('.market-chart');
            if (chartEl) {
                 Object.assign(chartEl.style, {
                    width: '100%', height: '120px', display: 'flex', justifyContent: 'space-around', alignItems: 'flex-end',
                    borderLeft: '2px solid #e5e7eb', borderBottom: '2px solid #e5e7eb', paddingTop: '10px', marginTop: '1rem'
                });
                marketContentWrapper.querySelectorAll('.chart-bar-group').forEach(el => Object.assign(el.style, { display: 'flex', flexDirection: 'column', alignItems: 'center', height: '100%', justifyContent: 'flex-end' }));
                marketContentWrapper.querySelectorAll('.chart-bar').forEach(el => Object.assign(el.style, { width: '25px', backgroundColor: '#6366f1', borderRadius: '4px 4px 0 0', position: 'relative' }));
                marketContentWrapper.querySelectorAll('.bar-value').forEach(el => Object.assign(el.style, { position: 'absolute', top: '-20px', left: '50%', transform: 'translateX(-50%)', fontSize: '0.7rem', fontWeight: '600', color: '#4f46e5' }));
                marketContentWrapper.querySelectorAll('.bar-year').forEach(el => Object.assign(el.style, { fontSize: '0.7rem', color: '#6b7280', marginTop: '4px' }));
            }
            
            backPage.appendChild(backHeader);
            backPage.appendChild(summaryHeader);
            backPage.appendChild(summaryContent);
            backPage.appendChild(marketContentWrapper);
            
            pdfContainer.appendChild(frontPage);
            pdfContainer.appendChild(backPage);
            document.body.appendChild(pdfContainer);

            // Use html2canvas to capture the styled container
            html2canvas(pdfContainer, { scale: 2 })
                .then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'px',
                        format: [canvas.width, canvas.height]
                    });
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save(`${card.front.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`);
                })
                .catch(err => {
                    console.error("PDF Export Error:", err);
                    alert("Sorry, something went wrong while exporting to PDF.");
                })
                .finally(() => {
                    document.body.removeChild(pdfContainer);
                });
        }
        
        function exportCardAsText() {
            if (flashcardsData.length === 0) return;

            const card = flashcardsData[currentCardIndex];
            
            // Create a temporary element to parse HTML and extract text content
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = card.marketInfo;
            const marketText = tempDiv.textContent || tempDiv.innerText || "";

            const content = `Title: ${card.front}\n\n` +
                          `--------------------\n` +
                          `Summary\n` +
                          `--------------------\n${card.summary}\n\n` +
                          `--------------------\n` +
                          `Market Snapshot\n` +
                          `--------------------\n${marketText.replace(/^Market Snapshot/, '').trim()}`;
            
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `${card.front.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.txt`;
            
            document.body.appendChild(a);
            a.click();
            
            // Clean up
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        
        // --- Event Listeners ---
        prevBtn.addEventListener('click', () => {
            if (currentCardIndex > 0) {
                currentCardIndex--;
                updateCardContent();
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentCardIndex < flashcardsData.length - 1) {
                currentCardIndex++;
                updateCardContent();
            }
        });

        flipBtn.addEventListener('click', () => flashcardEl.classList.toggle('is-flipped'));
        shuffleBtn.addEventListener('click', shuffleCards);
        exportPdfBtn.addEventListener('click', exportCardAsPDF);
        exportTxtBtn.addEventListener('click', exportCardAsText);
        
        // Modal & Form Listeners
        addCardBtn.addEventListener('click', () => addCardModal.classList.remove('hidden'));
        closeModalBtn.addEventListener('click', closeAndResetModal);
        addCardForm.addEventListener('submit', saveCard);
        
        generateAIBtn.addEventListener('click', () => {
            const title = document.getElementById('cardTitle').value;
            if (title) {
                fetchMarketData(title);
            } else {
                alert('Please enter a title first, or generate one from a screenshot.');
            }
        });
        
        // Selection Listeners
        manageDeckBtn.addEventListener('click', toggleSelectMode);
        selectionCheckbox.addEventListener('change', handleCardSelection);
        selectAllBtn.addEventListener('click', handleSelectAll);
        editCardBtn.addEventListener('click', editSelectedCard);
        deleteCardsBtn.addEventListener('click', deleteSelectedCards);
        confirmDeleteBtn.addEventListener('click', confirmDeletion);
        cancelDeleteBtn.addEventListener('click', () => deleteConfirmModal.classList.add('hidden'));


        // --- Drag and Drop Listeners ---
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('drag-over');
        });
        
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                 const file = files[0];
                 if (file.type.startsWith('image/')) {
                    screenshotUpload.files = files; // Make the file available to the input
                    fileNameEl.textContent = `Dropped: ${file.name}`;
                    analyzeScreenshot(file);
                } else {
                    alert('Please drop an image file.');
                }
            }
        });

        screenshotUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                fileNameEl.textContent = `Selected: ${file.name}`;
                analyzeScreenshot(file);
            }
        });


        // Tab switching logic
        tabButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation(); 
                tabButtons.forEach(btn => btn.classList.remove('active-tab'));
                button.classList.add('active-tab');

                const contentToShow = button.dataset.content;
                if (contentToShow === 'summary') {
                    summaryContentEl.classList.remove('hidden');
                    marketContentEl.classList.add('hidden');
                } else {
                    summaryContentEl.classList.add('hidden');
                    marketContentEl.classList.remove('hidden');
                }
            });
        });
        
        // --- Initial Load ---
        updateCardContent();
    </script>
</body>
</html>

