<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Flashcards</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- JS libraries for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVBL5gI9kLmbGkknNRZn1emmkSUpA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .flashcard-container {
            perspective: 1000px;
            -webkit-perspective: 1000px;
        }
        .flashcard {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            -webkit-transform-style: preserve-3d;
            transition: transform 0.7s cubic-bezier(0.4, 0.2, 0.2, 1);
        }
        .is-flipped {
            transform: rotateY(180deg);
        }
        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .flashcard-back {
            transform: rotateY(180deg) translateZ(1px); /* Safari rendering fix */
            -webkit-transform: rotateY(180deg) translateZ(1px); /* Safari rendering fix */
            justify-content: flex-start;
            align-items: flex-start;
            overflow-y: auto;
        }
        .flashcard-back h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #4f46e5;
        }
        .flashcard-back p {
            font-size: 0.90rem;
            line-height: 1.6;
            margin-bottom: 0.75rem;
        }
        /* Tab Styles */
        .tab-btn {
            padding: 0.5rem 1rem;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        .active-tab {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
        }
        /* Modal Styles */
        #addCardModal {
            transition: opacity 0.3s ease;
        }
        /* Market Chart Styles */
        .market-chart {
            width: 100%;
            height: 120px;
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            border-left: 2px solid #e5e7eb;
            border-bottom: 2px solid #e5e7eb;
            padding-top: 10px;
            margin-top: 1rem;
        }
        .chart-bar-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            justify-content: flex-end;
        }
        .chart-bar {
            width: 25px;
            background-color: #6366f1;
            border-radius: 4px 4px 0 0;
            position: relative;
            transition: height 0.5s ease-out;
        }
        .bar-value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            font-weight: 600;
            color: #4f46e5;
        }
        .bar-year {
            font-size: 0.7rem;
            color: #6b7280;
            margin-top: 4px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-100 via-purple-100 to-pink-100 text-slate-800 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-2xl mx-auto p-4 sm:p-6 text-center">
        <!-- Header -->
        <header class="mb-6">
            <h1 class="text-4xl font-bold text-slate-900">AI-Powered Flashcards</h1>
            <p class="text-slate-600 mt-2">Create, Study, and Export with AI Assistance</p>
        </header>

        <!-- Flashcard Component -->
        <div class="flashcard-container w-full h-[30rem] sm:h-[28rem]">
            <div class="flashcard">
                <div id="flashcard-front" class="flashcard-face">
                    <h2 class="text-2xl sm:text-3xl font-semibold text-center"></h2>
                </div>
                <div class="flashcard-face flashcard-back">
                     <div class="w-full flex flex-col h-full">
                        <div class="flex-shrink-0 w-full flex border-b border-slate-200 mb-2">
                            <button class="tab-btn active-tab" data-content="summary">Summary</button>
                            <button class="tab-btn" data-content="market">Market Snapshot</button>
                        </div>
                        <div class="flex-grow overflow-y-auto">
                            <div id="summary-content" class="tab-content text-left"></div>
                            <div id="market-content" class="tab-content hidden text-left"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Controls -->
        <div class="flex items-center justify-center space-x-2 sm:space-x-4 mt-6">
            <button id="shuffleBtn" class="p-3 bg-white/80 border border-slate-200 rounded-full shadow-sm text-slate-700 font-semibold hover:bg-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200" title="Shuffle Cards">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></svg>
            </button>
            <button id="flipBtn" class="px-6 py-3 bg-indigo-600 text-white rounded-full shadow-lg font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200 flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 17l5-5-5-5M19.8 12H2M8 7l-5 5 5 5"/></svg>
                <span>Flip Card</span>
            </button>
            <!-- Export Buttons -->
            <button id="exportPdfBtn" class="p-3 bg-white/80 border border-slate-200 rounded-full shadow-sm text-slate-700 font-semibold hover:bg-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200" title="Export as PDF">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><polyline points="9 15 12 12 15 15"></polyline></svg>
            </button>
             <button id="exportTxtBtn" class="p-3 bg-white/80 border border-slate-200 rounded-full shadow-sm text-slate-700 font-semibold hover:bg-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200" title="Export as Text">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="9" y1="13" x2="15" y2="13"></line><line x1="9" y1="17" x2="15" y2="17"></line><line x1="9" y1="9" x2="9" y2="9"></line></svg>
            </button>
        </div>

        <!-- Navigation Controls -->
        <div class="flex items-center justify-center space-x-4 mt-4">
            <button id="prevBtn" class="p-4 bg-white/80 border border-slate-200 rounded-full shadow-sm text-slate-700 font-semibold hover:bg-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed" title="Previous">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <span id="cardCounter" class="text-lg font-medium text-slate-700 w-24"></span>
            <button id="nextBtn" class="p-4 bg-white/80 border border-slate-200 rounded-full shadow-sm text-slate-700 font-semibold hover:bg-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed" title="Next">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
            </button>
        </div>
    </div>
    
    <!-- Footer and Action Buttons -->
    <footer class="fixed bottom-4 left-4 right-4 z-10 flex justify-between">
         <button id="addCardBtn" class="px-4 py-2 bg-white/80 backdrop-blur-sm rounded-full text-sm text-slate-600 hover:text-slate-900 transition shadow-md flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
             Add Card
         </button>
         <button id="feedbackBtn" class="px-4 py-2 bg-white/80 backdrop-blur-sm rounded-full text-sm text-slate-600 hover:text-slate-900 transition shadow-md">Give Feedback</button>
    </footer>
    
    <!-- Add Card Modal -->
    <div id="addCardModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-6 relative">
            <button id="closeModalBtn" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800">&times;</button>
            <h3 class="text-xl font-semibold mb-4">Add a New Flashcard</h3>
            <form id="addCardForm">
                <div class="mb-4">
                    <label for="cardTitle" class="block text-sm font-medium text-slate-700 text-left mb-1">Title</label>
                    <input type="text" id="cardTitle" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., The Future of Quantum Computing" required>
                </div>
                <div class="mb-4">
                    <label for="cardSummary" class="block text-sm font-medium text-slate-700 text-left mb-1">Summary</label>
                    <textarea id="cardSummary" rows="4" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" placeholder="Provide a brief summary of the topic." required></textarea>
                </div>
                 <div class="text-right">
                    <button id="generateAIBtn" type="button" class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-md font-semibold hover:bg-indigo-200 transition flex items-center gap-2">
                         <svg id="ai-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.5 13.5c.34.34.66.7.97 1.09.28.36.55.73.81 1.12.26.39.52.78.77 1.18.25.4.5.8.74 1.21.24.41.48.82.72 1.24.23.4.47.8.7 1.19.23.39.46.78.68 1.17.22.39.44.78.65 1.17s.42.78.62 1.17c.2.39.4.78.59 1.17.19.39.38.78.56 1.17.18.39.36.78.54 1.17.18.39.35.78.52 1.17.17.39.34.78.51 1.17.17.39.33.78.49 1.17.16.39.32.78.48 1.17.16.39.31.78.46 1.17.15.39.3.78.45 1.17.15.39.29.78.43 1.17.14.39.28.78.42 1.17.14.39.27.78.41 1.17.14.39.27.78.4 1.17.13.39.26.78.39 1.17.13.39.25.78.38 1.17.13.39.25.78.37 1.17.12.39.24.78.36 1.17.12.39.23.78.35 1.17.12.39.23.78.34 1.17.11.39.22.78.33 1.17.11.39.22.78.32 1.17.1.39.21.78.31 1.17.1.39.2.78.3 1.17.1.39.19.78.29 1.17.1.39.19.78.28 1.17.09.39.18.78.27 1.17.09.39.18.78.27 1.17.09.39.17.78.26 1.17.09.39.17.78.25 1.17.08.39.16.78.24 1.17.08.39.16.78.24 1.17.08.39.15.78.23 1.17.08.39.15.78.22 1.17.07.39.14.78.21 1.17.07.39.14.78.21 1.17.07.39.13.78.2 1.17.07.39.13.78.2 1.17.06.39.12.78.19 1.17.06.39.12.78.18 1.17.06.39.12.78.18 1.17.06.39.11.78.17 1.17.05.39.11.78.16 1.17.05.39.1.78.15 1.17.05.39.1.78.15 1.17.05.39.09.78.14 1.17.04.39.09.78.13 1.17.04.39.08.78.12 1.17.04.39.08.78.12 1.17.04.39.07.78.11 1.17.03.39.07.78.1 1.17.03.39.06.78.09 1.17.03.39.06.78.09 1.17.03.39.05.78.08 1.17.02.39.05.78.07 1.17.02.39.04.78.06 1.17.02.39.04.78.06 1.17.02.39.03.78.05 1.17.01.39.03.78.04 1.17.01.39.02.78.03 1.17.01.39.02.78.03 1.17.01.39.01.78.02 1.17.01.39.01.78.01 1.17z"/><path d="m14.5 9.5-.97-1.09c-.28-.36-.55-.73-.81-1.12c-.26-.39-.52-.78-.77-1.18c-.25-.4-.5-.8-.74-1.21c-.24-.41-.48-.82-.72-1.24c-.23-.4-.47-.8-.7-1.19c-.23-.39-.46-.78-.68-1.17c-.22-.39-.44-.78-.65-1.17s-.42-.78-.62-1.17c-.2-.39-.4-.78-.59-1.17c-.19-.39-.38-.78-.56-1.17c-.18-.39-.36-.78-.54-1.17c-.18-.39-.35-.78-.52-1.17c-.17-.39-.34-.78-.51-1.17c-.17-.39-.33-.78-.49-1.17c-.16-.39-.32-.78-.48-1.17c-.16-.39-.31-.78-.46-1.17c-.15-.39-.3-.78-.45-1.17c-.15-.39-.29-.78-.43-1.17c-.14-.39-.28-.78-.42-1.17c-.14-.39-.27-.78-.41-1.17c-.14-.39-.27-.78-.4-1.17c-.13-.39-.26-.78-.39-1.17c-.13-.39-.25-.78-.38-1.17c-.13-.39-.25-.78-.37-1.17c-.12-.39-.24-.78-.36-1.17c-.12-.39-.23-.78-.35-1.17c-.12-.39-.23-.78-.34-1.17c-.11-.39-.22-.78-.33-1.17c-.11-.39-.22-.78-.32-1.17c-.1-.39-.21-.78-.31-1.17c-.1-.39-.2-.78-.3-1.17c-.1-.39-.19-.78-.29-1.17c-.1-.39-.19-.78-.28-1.17c-.09-.39-.18-.78-.27-1.17c-.09-.39-.18-.78-.27-1.17c-.09-.39-.17-.78-.26-1.17c-.09-.39-.17-.78-.25-1.17c-.08-.39-.16-.78-.24-1.17c-.08-.39-.16-.78-.24-1.17c-.08-.39-.15-.78-.23-1.17c-.08-.39-.15-.78-.22-1.17c-.07-.39-.14-.78-.21-1.17c-.07-.39-.14-.78-.21-1.17c-.07-.39-.13-.78-.2-1.17c-.07-.39-.13-.78-.2-1.17c-.06-.39-.12-.78-.19-1.17c-.06-.39-.12-.78-.18-1.17c-.06-.39-.12-.78-.18-1.17c-.06-.39-.11-.78-.17-1.17c-.05-.39-.11-.78-.16-1.17c-.05-.39-.1-.78-.15-1.17c-.05-.39-.1-.78-.15-1.17c-.05-.39-.09-.78-.14-1.17c-.04-.39-.09-.78-.13-1.17c-.04-.39-.08-.78-.12-1.17c-.04-.39-.08-.78-.12-1.17c-.04-.39-.07-.78-.11-1.17c-.03-.39-.07-.78-.1-1.17c-.03-.39-.06-.78-.09-1.17c-.03-.39-.06-.78-.09-1.17c-.03-.39-.05-.78-.08-1.17c-.02-.39-.05-.78-.07-1.17c-.02-.39-.04-.78-.06-1.17c-.02-.39-.04-.78-.06-1.17c-.02-.39-.03-.78-.05-1.17c-.01-.39-.03-.78-.04-1.17c-.01-.39-.02-.78-.03-1.17c-.01-.39-.02-.78-.03-1.17c-.01-.39-.01-.78-.02-1.17c-.01-.39-.01-.78-.01-1.17z"/></svg>
                         <svg id="ai-loader" class="animate-spin h-5 w-5 text-indigo-700 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                         </svg>
                         <span id="ai-btn-text">Generate with AI</span>
                    </button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md font-semibold hover:bg-indigo-700 transition">Add Card to Deck</button>
                </div>
            </form>
        </div>
    </div>


        <script>
        const { jsPDF } = window.jspdf;
        const APIKEY = "AIzaSyD9xRkAan0WhW8GTegveSaU5gaInCO4Yy0";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${API_KEY}`;


        // --- Helper function to create chart HTML ---
        function createBarChart(data, unit) {
            if (!data || data.length === 0) return '<p>No chart data available.</p>';
            const maxValue = Math.max(...data.map(d => d.value));
            const bars = data.map(d => `
                <div class="chart-bar-group">
                    <div class="chart-bar" style="height: ${(d.value / maxValue) * 100}%;">
                        <span class="bar-value">${unit}${d.value}</span>
                    </div>
                    <span class="bar-year">${d.year}</span>
                </div>
            `).join('');
            return `<div class="market-chart">${bars}</div>`;
        }
        
        // --- Initial Flashcard Data ---
        let flashcardsData = [
            {
                front: "FDA Approves Zoryve Cream",
                summary: "The FDA has approved roflumilast 0.05% cream for pediatric atopic dermatitis, a non-contagious chronic skin condition. This steroid-free, once-daily treatment targets the underlying inflammatory causes of eczema.",
                marketInfo: `
                    <h3>Market Snapshot: Atopic Dermatitis</h3>
                    <p>The global atopic dermatitis market is projected to grow from ~$14B in 2024 to over $22B by 2029, with a CAGR of <strong>9.8%</strong>. This growth is driven by rising prevalence and the launch of novel biologic and non-steroidal therapies.</p>
                    ${createBarChart([
                        { year: 2021, value: 11.2 }, { year: 2022, value: 12.1 }, { year: 2023, value: 13.0 }, { year: 2024, value: 14.1 }, { year: 2025, value: 15.5 }
                    ], '$')}
                `,
                chartData: [ { year: 2021, value: 11.2 }, { year: 2022, value: 12.1 }, { year: 2023, value: 13.0 }, { year: 2024, value: 14.1 }, { year: 2025, value: 15.5 } ]
            },
            {
                front: "Roche's $2.7B Carmot Deal",
                summary: "Roche announced a definitive merger agreement to acquire Carmot Therapeutics for $2.7 billion upfront, gaining access to its R&D portfolio of clinical-stage incretins, including a promising Phase-2 ready dual GLP-1/GIP agonist, CT-388.",
                marketInfo: `
                    <h3>Market Snapshot: Obesity Drugs</h3>
                    <p>The global obesity drug market is experiencing explosive growth, projected to soar from ~$35B in 2024 to over $100B by 2030, with a CAGR of over <strong>25%</strong>. This is fueled by highly effective GLP-1 agonists.</p>
                    ${createBarChart([
                        { year: 2021, value: 2.5 }, { year: 2022, value: 6 }, { year: 2023, value: 20 }, { year: 2024, value: 35 }, { year: 2025, value: 55 }
                    ], '$')}
                `,
                chartData: [ { year: 2021, value: 2.5 }, { year: 2022, value: 6 }, { year: 2023, value: 20 }, { year: 2024, value: 35 }, { year: 2025, value: 55 } ]
            },
        ];

        // --- DOM Elements ---
        const frontEl = document.getElementById('flashcard-front').querySelector('h2');
        const summaryContentEl = document.getElementById('summary-content');
        const marketContentEl = document.getElementById('market-content');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const cardCounterEl = document.getElementById('cardCounter');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const flipBtn = document.getElementById('flipBtn');
        const shuffleBtn = document.getElementById('shuffleBtn');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const exportTxtBtn = document.getElementById('exportTxtBtn');
        const flashcardEl = document.querySelector('.flashcard');
        const feedbackBtn = document.getElementById('feedbackBtn');
        
        // Modal Elements
        const addCardBtn = document.getElementById('addCardBtn');
        const addCardModal = document.getElementById('addCardModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const addCardForm = document.getElementById('addCardForm');
        const generateAIBtn = document.getElementById('generateAIBtn');
        const aiLoader = document.getElementById('ai-loader');
        const aiIcon = document.getElementById('ai-icon');
        const aiBtnText = document.getElementById('ai-btn-text');


        let currentCardIndex = 0;
        let marketDataCache = null;

        // --- Core Functions ---
        function updateCardContent() {
            if (flashcardsData.length === 0) {
                frontEl.textContent = "No cards in deck. Add one!";
                summaryContentEl.innerHTML = "";
                marketContentEl.innerHTML = "";
                cardCounterEl.textContent = `0 / 0`;
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                return;
            }

            const card = flashcardsData[currentCardIndex];
            frontEl.textContent = card.front;
            summaryContentEl.innerHTML = `<p>${card.summary}</p>`;
            marketContentEl.innerHTML = card.marketInfo;
            
            cardCounterEl.textContent = `${currentCardIndex + 1} / ${flashcardsData.length}`;
            
            if (flashcardEl.classList.contains('is-flipped')) {
                flashcardEl.classList.remove('is-flipped');
            }

            prevBtn.disabled = currentCardIndex === 0;
            nextBtn.disabled = currentCardIndex === flashcardsData.length - 1;

            // Reset tabs to default view
            document.querySelector('[data-content="summary"]').classList.add('active-tab');
            document.querySelector('[data-content="market"]').classList.remove('active-tab');
            summaryContentEl.classList.remove('hidden');
            marketContentEl.classList.add('hidden');
        }

        function shuffleCards() {
            for (let i = flashcardsData.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [flashcardsData[i], flashcardsData[j]] = [flashcardsData[j], flashcardsData[i]];
            }
            currentCardIndex = 0;
            updateCardContent();
        }

        // --- AI & Form Functions ---
        async function fetchMarketData(topic) {
            aiLoader.classList.remove('hidden');
            aiIcon.classList.add('hidden');
            aiBtnText.textContent = "Generating...";
            generateAIBtn.disabled = true;

            const prompt = `
                For the topic "${topic}", find the relevant industry market size, its projected Compound Annual Growth Rate (CAGR), and a brief, one-sentence analysis of the key driver.
                Also, provide the market size data for the last 5 years, including the current year.
                
                Return the data ONLY in the following JSON format:
                {
                  "marketName": "Name of the Market",
                  "analysis": "A single sentence analyzing the market growth driver.",
                  "cagr": 9.8,
                  "chartData": [
                    { "year": 2021, "value": 11.2 },
                    { "year": 2022, "value": 12.1 },
                    { "year": 2023, "value": 13.0 },
                    { "year": 2024, "value": 14.1 },
                    { "year": 2025, "value": 15.5 }
                  ]
                }
            `;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.statusText}`);
                }

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                const cleanedText = text.replace(/```json/g, '').replace(/```/g, '');
                const jsonData = JSON.parse(cleanedText);
                marketDataCache = jsonData; // Cache the data
                alert('AI data generated successfully! You can now add the card.');

            } catch (error) {
                console.error("AI Generation Error:", error);
                alert("Failed to generate AI data. Please check the console for details or try again.");
                marketDataCache = null;
            } finally {
                aiLoader.classList.add('hidden');
                aiIcon.classList.remove('hidden');
                aiBtnText.textContent = "Generate with AI";
                generateAIBtn.disabled = false;
            }
        }
        
        function addCard(event) {
            event.preventDefault();
            const title = document.getElementById('cardTitle').value;
            const summary = document.getElementById('cardSummary').value;

            if (!marketDataCache) {
                alert('Please generate the AI market data first.');
                return;
            }

            const newCard = {
                front: title,
                summary: summary,
                marketInfo: `
                    <h3>Market Snapshot: ${marketDataCache.marketName}</h3>
                    <p>${marketDataCache.analysis} The market has a projected CAGR of <strong>${marketDataCache.cagr}%</strong>.</p>
                    ${createBarChart(marketDataCache.chartData, '$')}
                `,
                chartData: marketDataCache.chartData
            };

            flashcardsData.push(newCard);
            currentCardIndex = flashcardsData.length - 1;
            updateCardContent();
            
            // Close modal and reset form
            addCardModal.classList.add('hidden');
            addCardForm.reset();
            marketDataCache = null;
        }

        // --- Export Functions ---
        function exportCardAsPDF() {
            if (flashcardsData.length === 0) return;
            const card = flashcardsData[currentCardIndex];
            // ... (rest of the PDF export code is unchanged)
        }
        
        function exportCardAsText() {
            if (flashcardsData.length === 0) return;
            const card = flashcardsData[currentCardIndex];
            // ... (rest of the text export code is unchanged)
        }

        
        // --- Event Listeners ---
        prevBtn.addEventListener('click', () => {
            if (currentCardIndex > 0) {
                currentCardIndex--;
                updateCardContent();
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentCardIndex < flashcardsData.length - 1) {
                currentCardIndex++;
                updateCardContent();
            }
        });

        flipBtn.addEventListener('click', () => {
            flashcardEl.classList.toggle('is-flipped');
        });

        shuffleBtn.addEventListener('click', shuffleCards);
        exportPdfBtn.addEventListener('click', exportCardAsPDF);
        exportTxtBtn.addEventListener('click', exportCardAsText);
        
        // Modal Listeners
        addCardBtn.addEventListener('click', () => addCardModal.classList.remove('hidden'));
        closeModalBtn.addEventListener('click', () => addCardModal.classList.add('hidden'));
        addCardForm.addEventListener('submit', addCard);
        generateAIBtn.addEventListener('click', () => {
            const title = document.getElementById('cardTitle').value;
            if (title) {
                fetchMarketData(title);
            } else {
                alert('Please enter a title first.');
            }
        });


        // Tab switching logic
        tabButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation(); 
                tabButtons.forEach(btn => btn.classList.remove('active-tab'));
                button.classList.add('active-tab');

                const contentToShow = button.dataset.content;
                if (contentToShow === 'summary') {
                    summaryContentEl.classList.remove('hidden');
                    marketContentEl.classList.add('hidden');
                } else {
                    summaryContentEl.classList.add('hidden');
                    marketContentEl.classList.remove('hidden');
                }
            });
        });
        
        // --- Initial Load ---
        updateCardContent();
    </script>
</body>
</html>

